<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="本文将通过几个方面来介绍插入式注解。包括如何搭建项目环境，如何编写注解处理器，以及编写 idea 插件使注解生成的代码不会报错。\n示例代码地址\n插入式注解代码地址：samples/pluggable-annotation 测试代码地址：samples/pluggable-annotation-test 插件的代码地址：samples/pluggable-annotation-idea-plugin 什么是插入式注解 JSR-269 插件化注解处理(Pluggable Annotation Processing API)\n可以在编译期期间对代码进行处理，像经常用的 lombok 也是基于这个原理，通过注解生成 getter/setter 等方法。\njavac 会通过 SPI 机制，找到要调用的注解处理器，处理完源代码后再去生成字节码。\n搭建项目环境 在编写注解处理器时，需要通过修改语法树来达成修改代码的效果，java 提供了对应的方法，但限制了访问，得自己引入。\n在 jdk8 中，可以通过引入 java安装路径/lib/tools.jar 来实现，而在 jdk8 以上的版本，已经不提供这个 tools.jar 了。那么在 jdk8 以上如何实现效果？就得自定义编译选项了，可以修改 maven 中编译插件的配置来达成目的。\n1 2 3 4 5 6 7 8 <compilerArgs> <arg>--add-exports=jdk.compiler/com.sun.tools.javac.tree=ALL-UNNAMED</arg> <arg>--add-exports=jdk.compiler/com.sun.tools.javac.util=ALL-UNNAMED</arg> <arg>--add-exports=jdk.compiler/com.sun.tools.javac.code=ALL-UNNAMED</arg> <arg>--add-exports=jdk.compiler/com.sun.tools.javac.model=ALL-UNNAMED</arg> <arg>--add-exports=jdk.compiler/com.sun.tools.javac.processing=ALL-UNNAMED</arg> <arg>--add-exports=jdk.compiler/com.sun.tools.javac.api=ALL-UNNAMED</arg> </compilerArgs> --add-exports 和 --add-opens （lombok 用的是这个）有细微差别，我测试了下，使用 --add-opens 会编译报错，因为我不想纠结这个事情，于是便不求甚解了。\n除此之外，还得配置一个参数：-proc:none 。这个是控制 javac 编译时的行为，-proc:none 指不使用注释处理器，只编译源文件。\n"><title>java 插入式注解</title>
<link rel=canonical href=https://w2tbp.github.io/blog/p/java-%E6%8F%92%E5%85%A5%E5%BC%8F%E6%B3%A8%E8%A7%A3/><link rel=stylesheet href=/blog/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css><meta property='og:title' content="java 插入式注解"><meta property='og:description' content="本文将通过几个方面来介绍插入式注解。包括如何搭建项目环境，如何编写注解处理器，以及编写 idea 插件使注解生成的代码不会报错。\n示例代码地址\n插入式注解代码地址：samples/pluggable-annotation 测试代码地址：samples/pluggable-annotation-test 插件的代码地址：samples/pluggable-annotation-idea-plugin 什么是插入式注解 JSR-269 插件化注解处理(Pluggable Annotation Processing API)\n可以在编译期期间对代码进行处理，像经常用的 lombok 也是基于这个原理，通过注解生成 getter/setter 等方法。\njavac 会通过 SPI 机制，找到要调用的注解处理器，处理完源代码后再去生成字节码。\n搭建项目环境 在编写注解处理器时，需要通过修改语法树来达成修改代码的效果，java 提供了对应的方法，但限制了访问，得自己引入。\n在 jdk8 中，可以通过引入 java安装路径/lib/tools.jar 来实现，而在 jdk8 以上的版本，已经不提供这个 tools.jar 了。那么在 jdk8 以上如何实现效果？就得自定义编译选项了，可以修改 maven 中编译插件的配置来达成目的。\n1 2 3 4 5 6 7 8 <compilerArgs> <arg>--add-exports=jdk.compiler/com.sun.tools.javac.tree=ALL-UNNAMED</arg> <arg>--add-exports=jdk.compiler/com.sun.tools.javac.util=ALL-UNNAMED</arg> <arg>--add-exports=jdk.compiler/com.sun.tools.javac.code=ALL-UNNAMED</arg> <arg>--add-exports=jdk.compiler/com.sun.tools.javac.model=ALL-UNNAMED</arg> <arg>--add-exports=jdk.compiler/com.sun.tools.javac.processing=ALL-UNNAMED</arg> <arg>--add-exports=jdk.compiler/com.sun.tools.javac.api=ALL-UNNAMED</arg> </compilerArgs> --add-exports 和 --add-opens （lombok 用的是这个）有细微差别，我测试了下，使用 --add-opens 会编译报错，因为我不想纠结这个事情，于是便不求甚解了。\n除此之外，还得配置一个参数：-proc:none 。这个是控制 javac 编译时的行为，-proc:none 指不使用注释处理器，只编译源文件。\n"><meta property='og:url' content='https://w2tbp.github.io/blog/p/java-%E6%8F%92%E5%85%A5%E5%BC%8F%E6%B3%A8%E8%A7%A3/'><meta property='og:site_name' content='w2tbp'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='java'><meta property='article:published_time' content='2024-04-29T15:27:38+00:00'><meta property='article:modified_time' content='2024-04-29T15:27:38+00:00'><meta name=twitter:title content="java 插入式注解"><meta name=twitter:description content="本文将通过几个方面来介绍插入式注解。包括如何搭建项目环境，如何编写注解处理器，以及编写 idea 插件使注解生成的代码不会报错。\n示例代码地址\n插入式注解代码地址：samples/pluggable-annotation 测试代码地址：samples/pluggable-annotation-test 插件的代码地址：samples/pluggable-annotation-idea-plugin 什么是插入式注解 JSR-269 插件化注解处理(Pluggable Annotation Processing API)\n可以在编译期期间对代码进行处理，像经常用的 lombok 也是基于这个原理，通过注解生成 getter/setter 等方法。\njavac 会通过 SPI 机制，找到要调用的注解处理器，处理完源代码后再去生成字节码。\n搭建项目环境 在编写注解处理器时，需要通过修改语法树来达成修改代码的效果，java 提供了对应的方法，但限制了访问，得自己引入。\n在 jdk8 中，可以通过引入 java安装路径/lib/tools.jar 来实现，而在 jdk8 以上的版本，已经不提供这个 tools.jar 了。那么在 jdk8 以上如何实现效果？就得自定义编译选项了，可以修改 maven 中编译插件的配置来达成目的。\n1 2 3 4 5 6 7 8 <compilerArgs> <arg>--add-exports=jdk.compiler/com.sun.tools.javac.tree=ALL-UNNAMED</arg> <arg>--add-exports=jdk.compiler/com.sun.tools.javac.util=ALL-UNNAMED</arg> <arg>--add-exports=jdk.compiler/com.sun.tools.javac.code=ALL-UNNAMED</arg> <arg>--add-exports=jdk.compiler/com.sun.tools.javac.model=ALL-UNNAMED</arg> <arg>--add-exports=jdk.compiler/com.sun.tools.javac.processing=ALL-UNNAMED</arg> <arg>--add-exports=jdk.compiler/com.sun.tools.javac.api=ALL-UNNAMED</arg> </compilerArgs> --add-exports 和 --add-opens （lombok 用的是这个）有细微差别，我测试了下，使用 --add-opens 会编译报错，因为我不想纠结这个事情，于是便不求甚解了。\n除此之外，还得配置一个参数：-proc:none 。这个是控制 javac 编译时的行为，-proc:none 指不使用注释处理器，只编译源文件。\n"></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><div class=site-meta><h1 class=site-name><a href=/blog>w2tbp</a></h1><h2 class=site-description></h2></div></header><ol class=menu id=main-menu><li><a href=/blog/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/blog/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/blog/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#什么是插入式注解>什么是插入式注解</a></li><li><a href=#搭建项目环境>搭建项目环境</a></li><li><a href=#注解处理器编写>注解处理器编写</a></li><li><a href=#测试>测试</a></li><li><a href=#idea-插件>idea 插件</a></li><li><a href=#其他>其他</a><ol><li><a href=#报错-java-javalangillegalargumentexception>报错 java: java.lang.IllegalArgumentException</a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/blog/p/java-%E6%8F%92%E5%85%A5%E5%BC%8F%E6%B3%A8%E8%A7%A3/>java 插入式注解</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Apr 29, 2024</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 3 分钟</time></div></footer></div></header><section class=article-content><p>本文将通过几个方面来介绍插入式注解。包括如何搭建项目环境，如何编写注解处理器，以及编写 idea 插件使注解生成的代码不会报错。</p><p>示例代码地址</p><ul><li>插入式注解代码地址：<a class=link href=https://github.com/w2tbp/samples/tree/main/pluggable-annotation target=_blank rel=noopener>samples/pluggable-annotation</a></li><li>测试代码地址：<a class=link href=https://github.com/w2tbp/samples/tree/main/pluggable-annotation-test target=_blank rel=noopener>samples/pluggable-annotation-test</a></li><li>插件的代码地址：<a class=link href=https://github.com/w2tbp/samples/tree/main/pluggable-annotation-idea-plugin target=_blank rel=noopener>samples/pluggable-annotation-idea-plugin</a></li></ul><h2 id=什么是插入式注解>什么是插入式注解</h2><p>JSR-269 插件化注解处理(Pluggable Annotation Processing API)</p><p>可以在编译期期间对代码进行处理，像经常用的 lombok 也是基于这个原理，通过注解生成 getter/setter 等方法。</p><p>javac 会通过 SPI 机制，找到要调用的注解处理器，处理完源代码后再去生成字节码。</p><h2 id=搭建项目环境>搭建项目环境</h2><p>在编写注解处理器时，需要通过修改语法树来达成修改代码的效果，java 提供了对应的方法，但限制了访问，得自己引入。</p><p>在 jdk8 中，可以通过引入 <code>java安装路径/lib/tools.jar</code> 来实现，而在 jdk8 以上的版本，已经不提供这个 tools.jar 了。那么在 jdk8 以上如何实现效果？就得自定义编译选项了，可以修改 maven 中编译插件的配置来达成目的。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;compilerArgs&gt;</span>            
</span></span><span class=line><span class=cl>	<span class=nt>&lt;arg&gt;</span>--add-exports=jdk.compiler/com.sun.tools.javac.tree=ALL-UNNAMED<span class=nt>&lt;/arg&gt;</span>  
</span></span><span class=line><span class=cl>	<span class=nt>&lt;arg&gt;</span>--add-exports=jdk.compiler/com.sun.tools.javac.util=ALL-UNNAMED<span class=nt>&lt;/arg&gt;</span>  
</span></span><span class=line><span class=cl>	<span class=nt>&lt;arg&gt;</span>--add-exports=jdk.compiler/com.sun.tools.javac.code=ALL-UNNAMED<span class=nt>&lt;/arg&gt;</span>  
</span></span><span class=line><span class=cl>	<span class=nt>&lt;arg&gt;</span>--add-exports=jdk.compiler/com.sun.tools.javac.model=ALL-UNNAMED<span class=nt>&lt;/arg&gt;</span>  
</span></span><span class=line><span class=cl>	<span class=nt>&lt;arg&gt;</span>--add-exports=jdk.compiler/com.sun.tools.javac.processing=ALL-UNNAMED<span class=nt>&lt;/arg&gt;</span>  
</span></span><span class=line><span class=cl>	<span class=nt>&lt;arg&gt;</span>--add-exports=jdk.compiler/com.sun.tools.javac.api=ALL-UNNAMED<span class=nt>&lt;/arg&gt;</span>  
</span></span><span class=line><span class=cl><span class=nt>&lt;/compilerArgs&gt;</span> 
</span></span></code></pre></td></tr></table></div></div><p><code>--add-exports</code> 和 <code>--add-opens</code> （lombok 用的是这个）有细微差别，我测试了下，使用 <code>--add-opens</code> 会编译报错，因为我不想纠结这个事情，于是便不求甚解了。</p><p>除此之外，还得配置一个参数：<code>-proc:none</code> 。这个是控制 javac 编译时的行为，<code>-proc:none</code> 指不使用注释处理器，只编译源文件。</p><p>maven 插件完整代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;plugin&gt;</span>  
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>org.apache.maven.plugins<span class=nt>&lt;/groupId&gt;</span>  
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>maven-compiler-plugin<span class=nt>&lt;/artifactId&gt;</span>  
</span></span><span class=line><span class=cl>    <span class=nt>&lt;version&gt;</span>3.8.1<span class=nt>&lt;/version&gt;</span>  
</span></span><span class=line><span class=cl>    <span class=nt>&lt;configuration&gt;</span>        
</span></span><span class=line><span class=cl>	    <span class=nt>&lt;source&gt;</span>${maven.compiler.source}<span class=nt>&lt;/source&gt;</span>  
</span></span><span class=line><span class=cl>        <span class=nt>&lt;target&gt;</span>${maven.compiler.target}<span class=nt>&lt;/target&gt;</span>  
</span></span><span class=line><span class=cl>        <span class=nt>&lt;compilerArgs&gt;</span>         
</span></span><span class=line><span class=cl>	        <span class=nt>&lt;arg&gt;</span>-proc:none<span class=nt>&lt;/arg&gt;</span>   
</span></span><span class=line><span class=cl>	        <span class=nt>&lt;arg&gt;</span>--add-exports=jdk.compiler/com.sun.tools.javac.tree=ALL-UNNAMED<span class=nt>&lt;/arg&gt;</span>  
</span></span><span class=line><span class=cl>            <span class=nt>&lt;arg&gt;</span>--add-exports=jdk.compiler/com.sun.tools.javac.util=ALL-UNNAMED<span class=nt>&lt;/arg&gt;</span>  
</span></span><span class=line><span class=cl>            <span class=nt>&lt;arg&gt;</span>--add-exports=jdk.compiler/com.sun.tools.javac.code=ALL-UNNAMED<span class=nt>&lt;/arg&gt;</span>  
</span></span><span class=line><span class=cl>            <span class=nt>&lt;arg&gt;</span>--add-exports=jdk.compiler/com.sun.tools.javac.model=ALL-UNNAMED<span class=nt>&lt;/arg&gt;</span>  
</span></span><span class=line><span class=cl>            <span class=nt>&lt;arg&gt;</span>--add-exports=jdk.compiler/com.sun.tools.javac.processing=ALL-UNNAMED<span class=nt>&lt;/arg&gt;</span>  
</span></span><span class=line><span class=cl>            <span class=nt>&lt;arg&gt;</span>--add-exports=jdk.compiler/com.sun.tools.javac.api=ALL-UNNAMED<span class=nt>&lt;/arg&gt;</span>  
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/compilerArgs&gt;</span>    
</span></span><span class=line><span class=cl>	<span class=nt>&lt;/configuration&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/plugin&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>这里在顺手放一段 lombok 的配置：<a class=link href=https://github.com/projectlombok/lombok/blob/master/docker/maven/files/jdk-21/classpath/pom.xml target=_blank rel=noopener>lombok/docker/maven/files/jdk-21/classpath/pom.xml</a></p><p>而至于 jdk8 ，事情就简单多了，直接把 tool.jar 引入就完事了。完整代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl>...
</span></span><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>  
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>com.sun<span class=nt>&lt;/groupId&gt;</span>  
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>tools<span class=nt>&lt;/artifactId&gt;</span>  
</span></span><span class=line><span class=cl>    <span class=nt>&lt;version&gt;</span>1.8<span class=nt>&lt;/version&gt;</span>  
</span></span><span class=line><span class=cl>    <span class=nt>&lt;scope&gt;</span>system<span class=nt>&lt;/scope&gt;</span>  
</span></span><span class=line><span class=cl>    <span class=nt>&lt;systemPath&gt;</span>${java.home}/../lib/tools.jar<span class=nt>&lt;/systemPath&gt;</span>  
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl><span class=nt>&lt;plugin&gt;</span>  
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>org.apache.maven.plugins<span class=nt>&lt;/groupId&gt;</span>  
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>maven-compiler-plugin<span class=nt>&lt;/artifactId&gt;</span>  
</span></span><span class=line><span class=cl>    <span class=nt>&lt;version&gt;</span>3.8.1<span class=nt>&lt;/version&gt;</span>  
</span></span><span class=line><span class=cl>    <span class=nt>&lt;configuration&gt;</span>        
</span></span><span class=line><span class=cl>	    <span class=nt>&lt;source&gt;</span>${maven.compiler.source}<span class=nt>&lt;/source&gt;</span>  
</span></span><span class=line><span class=cl>        <span class=nt>&lt;target&gt;</span>${maven.compiler.target}<span class=nt>&lt;/target&gt;</span>  
</span></span><span class=line><span class=cl>        <span class=nt>&lt;compilerArgs&gt;</span>         
</span></span><span class=line><span class=cl>	        <span class=nt>&lt;arg&gt;</span>-proc:none<span class=nt>&lt;/arg&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/compilerArgs&gt;</span>    
</span></span><span class=line><span class=cl>	<span class=nt>&lt;/configuration&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/plugin&gt;</span>
</span></span><span class=line><span class=cl>...
</span></span></code></pre></td></tr></table></div></div><h2 id=注解处理器编写>注解处理器编写</h2><p>接下来进行代码的编写，既然是插入式注解，首先我们需要定义一个注解：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>com.w2tbp.samples.annotation</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.annotation.ElementType</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.annotation.Retention</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.annotation.RetentionPolicy</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.annotation.Target</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Target</span><span class=p>({</span><span class=n>ElementType</span><span class=p>.</span><span class=na>TYPE</span><span class=p>})</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Retention</span><span class=p>(</span><span class=n>RetentionPolicy</span><span class=p>.</span><span class=na>SOURCE</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=nd>@interface</span><span class=w> </span><span class=n>MyLog</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>然后编写注解处理器，得继承 AbstractProcessor 类，并重写 process 方法。在其中我们就能够调用 java 修改语法树的一系列 api，对代码进行一顿输出。</p><p>上一节费劲心思配置编译选项，把 tools.jar 引入，就是为了在编写注解处理器的时候调用这些 api。但关于修改语法树，也就是关于 JCTree 的一些语法，怎么使用，我就不多说了，因为我也不太了解 pwq，只是拿来用。</p><p>我写的这个注解处理器，是为了让代码生成一段这样的代码：</p><p><code>private final static Logger logger = LogManager.getLogger(Test.class);</code></p><p>完整代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>com.w2tbp.samples.annotation</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sun.tools.javac.api.JavacTrees</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sun.tools.javac.code.Flags</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sun.tools.javac.processing.JavacProcessingEnvironment</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sun.tools.javac.tree.JCTree</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sun.tools.javac.tree.TreeMaker</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sun.tools.javac.tree.TreeTranslator</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sun.tools.javac.util.*</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.logging.log4j.LogManager</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.logging.log4j.Logger</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>javax.annotation.processing.*</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>javax.lang.model.SourceVersion</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>javax.lang.model.element.Element</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>javax.lang.model.element.TypeElement</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.Set</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@SupportedAnnotationTypes</span><span class=p>(</span><span class=s>&#34;com.w2tbp.samples.annotation.MyLog&#34;</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MyLogProcessor</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>AbstractProcessor</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>JavacTrees</span><span class=w> </span><span class=n>javacTrees</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>TreeMaker</span><span class=w> </span><span class=n>treeMaker</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Names</span><span class=w> </span><span class=n>names</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>MyLog</span><span class=o>&gt;</span><span class=w> </span><span class=n>ANNOTATION_TO_PROCESS</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MyLog</span><span class=p>.</span><span class=na>class</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>LOG_CLASS_TYPE_NAME</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Logger</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getName</span><span class=p>();</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>LOG_FACTORY_CLASS_TYPE_NAME</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LogManager</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getName</span><span class=p>();</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>init</span><span class=p>(</span><span class=n>ProcessingEnvironment</span><span class=w> </span><span class=n>processingEnv</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>.</span><span class=na>init</span><span class=p>(</span><span class=n>processingEnv</span><span class=p>);</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>javacTrees</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>JavacTrees</span><span class=p>.</span><span class=na>instance</span><span class=p>(</span><span class=n>processingEnv</span><span class=p>);</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Context</span><span class=w> </span><span class=n>context</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>((</span><span class=n>JavacProcessingEnvironment</span><span class=p>)</span><span class=w> </span><span class=n>processingEnv</span><span class=p>).</span><span class=na>getContext</span><span class=p>();</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>treeMaker</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>TreeMaker</span><span class=p>.</span><span class=na>instance</span><span class=p>(</span><span class=n>context</span><span class=p>);</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>names</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Names</span><span class=p>.</span><span class=na>instance</span><span class=p>(</span><span class=n>context</span><span class=p>);</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>SourceVersion</span><span class=w> </span><span class=nf>getSupportedSourceVersion</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>SourceVersion</span><span class=p>.</span><span class=na>latest</span><span class=p>();</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>process</span><span class=p>(</span><span class=n>Set</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>TypeElement</span><span class=o>&gt;</span><span class=w> </span><span class=n>annotations</span><span class=p>,</span><span class=w> </span><span class=n>RoundEnvironment</span><span class=w> </span><span class=n>roundEnv</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>JCTree</span><span class=p>.</span><span class=na>JCExpression</span><span class=w> </span><span class=n>varTypeName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>strToJCExpression</span><span class=p>(</span><span class=n>LOG_CLASS_TYPE_NAME</span><span class=p>);</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>JCTree</span><span class=p>.</span><span class=na>JCExpression</span><span class=w> </span><span class=n>varFactoryName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>strToJCExpression</span><span class=p>(</span><span class=n>LOG_FACTORY_CLASS_TYPE_NAME</span><span class=p>);</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Name</span><span class=w> </span><span class=n>varName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>names</span><span class=p>.</span><span class=na>fromString</span><span class=p>(</span><span class=s>&#34;log&#34;</span><span class=p>);</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Set</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Element</span><span class=o>&gt;</span><span class=w> </span><span class=n>elements</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>roundEnv</span><span class=p>.</span><span class=na>getElementsAnnotatedWith</span><span class=p>(</span><span class=n>ANNOTATION_TO_PROCESS</span><span class=p>);</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Element</span><span class=w> </span><span class=n>element</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>elements</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>className</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>element</span><span class=p>.</span><span class=na>getSimpleName</span><span class=p>().</span><span class=na>toString</span><span class=p>()</span><span class=o>+</span><span class=s>&#34;.class&#34;</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>JCTree</span><span class=w> </span><span class=n>tree</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>javacTrees</span><span class=p>.</span><span class=na>getTree</span><span class=p>(</span><span class=n>element</span><span class=p>);</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>tree</span><span class=p>.</span><span class=na>accept</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>TreeTranslator</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nd>@Override</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>visitClassDef</span><span class=p>(</span><span class=n>JCTree</span><span class=p>.</span><span class=na>JCClassDecl</span><span class=w> </span><span class=n>jcClassDecl</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>JCTree</span><span class=p>.</span><span class=na>JCVariableDecl</span><span class=w> </span><span class=n>variableDecl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>treeMaker</span><span class=p>.</span><span class=na>VarDef</span><span class=p>(</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>treeMaker</span><span class=p>.</span><span class=na>Modifiers</span><span class=p>(</span><span class=n>Flags</span><span class=p>.</span><span class=na>PRIVATE</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>Flags</span><span class=p>.</span><span class=na>STATIC</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>Flags</span><span class=p>.</span><span class=na>FINAL</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>varName</span><span class=p>,</span><span class=w> </span><span class=n>varTypeName</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>treeMaker</span><span class=p>.</span><span class=na>Apply</span><span class=p>(</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=n>List</span><span class=p>.</span><span class=na>nil</span><span class=p>(),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=n>treeMaker</span><span class=p>.</span><span class=na>Select</span><span class=p>(</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>                                            </span><span class=n>varFactoryName</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>                                            </span><span class=n>names</span><span class=p>.</span><span class=na>fromString</span><span class=p>(</span><span class=s>&#34;getLogger&#34;</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=n>List</span><span class=p>.</span><span class=na>of</span><span class=p>(</span><span class=n>strToJCExpression</span><span class=p>(</span><span class=n>className</span><span class=p>))</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>);</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>jcClassDecl</span><span class=p>.</span><span class=na>defs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>jcClassDecl</span><span class=p>.</span><span class=na>defs</span><span class=p>.</span><span class=na>prepend</span><span class=p>(</span><span class=n>variableDecl</span><span class=p>);</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kd>super</span><span class=p>.</span><span class=na>visitClassDef</span><span class=p>(</span><span class=n>jcClassDecl</span><span class=p>);</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>});</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>JCTree</span><span class=p>.</span><span class=na>JCExpression</span><span class=w> </span><span class=nf>strToJCExpression</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>components</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>componentArray</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>components</span><span class=p>.</span><span class=na>split</span><span class=p>(</span><span class=s>&#34;\\.&#34;</span><span class=p>);</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>JCTree</span><span class=p>.</span><span class=na>JCExpression</span><span class=w> </span><span class=n>expr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>treeMaker</span><span class=p>.</span><span class=na>Ident</span><span class=p>(</span><span class=n>names</span><span class=p>.</span><span class=na>fromString</span><span class=p>(</span><span class=n>componentArray</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>));</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>componentArray</span><span class=p>.</span><span class=na>length</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>expr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>treeMaker</span><span class=p>.</span><span class=na>Select</span><span class=p>(</span><span class=n>expr</span><span class=p>,</span><span class=w> </span><span class=n>names</span><span class=p>.</span><span class=na>fromString</span><span class=p>(</span><span class=n>componentArray</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>));</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>expr</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>这样基本的事情就完事了，还剩下一件事，就是这个插入式注解得通过 SPI 的方式被编译器调用，所以需要配置一下。</p><p>具体是在 <code>src/main/resources/META-INF/services</code> 目录下新建一个 <code>javax.annotation.processing.Processor</code> 文件</p><p><img src=/blog/p/java-%E6%8F%92%E5%85%A5%E5%BC%8F%E6%B3%A8%E8%A7%A3/assets/pluggable-annotation.png width=269 height=63 srcset="/blog/p/java-%E6%8F%92%E5%85%A5%E5%BC%8F%E6%B3%A8%E8%A7%A3/assets/pluggable-annotation_hu5345047593177176152.png 480w, /blog/p/java-%E6%8F%92%E5%85%A5%E5%BC%8F%E6%B3%A8%E8%A7%A3/assets/pluggable-annotation_hu10157319832369540636.png 1024w" loading=lazy alt=SPI配置文件 class=gallery-image data-flex-grow=426 data-flex-basis=1024px></p><p>内容为注解处理器的路径：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl>com.w2tbp.samples.annotation.MyLogProcessor
</span></span></code></pre></td></tr></table></div></div><p>除了这种方式，还可以用谷歌的 <code>auto-service</code> 依赖，然后在注解处理器上直接用注解 <code>@AutoService</code> 就行了。</p><p>注解处理就告一段落了，完整代码地址在：<a class=link href=https://github.com/w2tbp/samples/tree/main/pluggable-annotation target=_blank rel=noopener>samples/pluggable-annotation</a></p><h2 id=测试>测试</h2><p>接下来测试一下。</p><p>新建一个项目，引入上面项目的依赖，简单写个测试类，编译后发现，我们想要的结果已经出现了：</p><p><img src=/blog/p/java-%E6%8F%92%E5%85%A5%E5%BC%8F%E6%B3%A8%E8%A7%A3/assets/pluggable-annotation-1.png width=673 height=367 srcset="/blog/p/java-%E6%8F%92%E5%85%A5%E5%BC%8F%E6%B3%A8%E8%A7%A3/assets/pluggable-annotation-1_hu14619434023266083365.png 480w, /blog/p/java-%E6%8F%92%E5%85%A5%E5%BC%8F%E6%B3%A8%E8%A7%A3/assets/pluggable-annotation-1_hu1503342278480105052.png 1024w" loading=lazy alt=.class文件 class=gallery-image data-flex-grow=183 data-flex-basis=440px></p><p>测试项目代码地址在：<a class=link href=https://github.com/w2tbp/samples/tree/main/pluggable-annotation-test target=_blank rel=noopener>samples/pluggable-annotation-test</a></p><h2 id=idea-插件>idea 插件</h2><p>现在我们知道可以生成语句，那么在代码中就可以用这个生成的对象了。但我们敲下 log 对象时，却出现了问题：</p><p><img src=/blog/p/java-%E6%8F%92%E5%85%A5%E5%BC%8F%E6%B3%A8%E8%A7%A3/assets/pluggable-annotation-2.png width=357 height=269 srcset="/blog/p/java-%E6%8F%92%E5%85%A5%E5%BC%8F%E6%B3%A8%E8%A7%A3/assets/pluggable-annotation-2_hu2313483352929294688.png 480w, /blog/p/java-%E6%8F%92%E5%85%A5%E5%BC%8F%E6%B3%A8%E8%A7%A3/assets/pluggable-annotation-2_hu2250925709371990693.png 1024w" loading=lazy alt=测试类 class=gallery-image data-flex-grow=132 data-flex-basis=318px></p><p>这个对象飘红了，这是正常的，因为现在并没有这个对象。但是在用 lombok 的时候显然没有这个问题，这是为什么呢？因为 lombok 在 idea 中用了插件，一些较旧的 idea 版本会让人自己装，但现在都集成了。</p><p>于是我们也来开发个自己的插件，当我们安装插件后，会看到和 lombok 一样的效果，log 也不报错了，也有代码提示了：</p><p><img src=/blog/p/java-%E6%8F%92%E5%85%A5%E5%BC%8F%E6%B3%A8%E8%A7%A3/assets/pluggable-annotation-3.png width=547 height=522 srcset="/blog/p/java-%E6%8F%92%E5%85%A5%E5%BC%8F%E6%B3%A8%E8%A7%A3/assets/pluggable-annotation-3_hu17730672863779636448.png 480w, /blog/p/java-%E6%8F%92%E5%85%A5%E5%BC%8F%E6%B3%A8%E8%A7%A3/assets/pluggable-annotation-3_hu7320167634667927701.png 1024w" loading=lazy alt=安装插件后 class=gallery-image data-flex-grow=104 data-flex-basis=251px></p><p>关于如何写插件，新建工程，怎么配置，如何实现，说起来也有点冗杂。代码基本上就是从 lombok 插件中 copy 的，ps：看它的那个插件源代码真是一件痛苦的事情。</p><p>插件的代码地址在：<a class=link href=https://github.com/w2tbp/samples/tree/main/pluggable-annotation-idea-plugin target=_blank rel=noopener>samples/pluggable-annotation-idea-plugin</a></p><p>可以直接下载项目目录下的 <code>pluggable-annotation-idea-plugin-1.0-SNAPSHOT.zip</code> ，然后在 idea 插件选项中，选择从磁盘中安装，安装此插件。</p><p>另需注意，IDEA 会有版本兼容问题，我这里使用的 IDEA 版本为 2024.1</p><h2 id=其他>其他</h2><h3 id=报错-java-javalangillegalargumentexception>报错 java: java.lang.IllegalArgumentException</h3><p>路径：Build, Execution, Deployment -> complier -> Shared build process VM options</p><p>加上该配置 <code>-Djps.track.ap.dependencies=false</code></p><p><img src=/blog/p/java-%E6%8F%92%E5%85%A5%E5%BC%8F%E6%B3%A8%E8%A7%A3/assets/pluggable-annotation-4.png width=779 height=560 srcset="/blog/p/java-%E6%8F%92%E5%85%A5%E5%BC%8F%E6%B3%A8%E8%A7%A3/assets/pluggable-annotation-4_hu6585747816969065319.png 480w, /blog/p/java-%E6%8F%92%E5%85%A5%E5%BC%8F%E6%B3%A8%E8%A7%A3/assets/pluggable-annotation-4_hu9435446374601438425.png 1024w" loading=lazy alt=虚拟机选项 class=gallery-image data-flex-grow=139 data-flex-basis=333px></p></section><footer class=article-footer><section class=article-tags><a href=/blog/tags/java/>Java</a></section></footer></article><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//hugo-theme-stack.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2023 -
2024 w2tbp</section><section class=powerby>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.29.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/blog/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>